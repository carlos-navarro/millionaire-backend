<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Prices</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
        integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

</head>

<body>
    <div class="container">
        <h1 id="welcome">Welcome</h1>
        <h2>Questions</h2>
        <div class="row">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title" id="question" data-question-id="0">Card title</h5>
                    <button type="button" class="btn btn-light" id="a0" data-answer-id="0">Light</button>
                    <button type="button" class="btn btn-light" id="a1" data-answer-id="0">Light</button>
                    <button type="button" class="btn btn-light" id="a2" data-answer-id="0">Light</button>
                    <button type="button" class="btn btn-light" id="a3" data-answer-id="0">Light</button>
                </div>
            </div>
        </div>
        <div class="row">
            <h2>Final Score Board</h2>
            <table class="table" id="score">
                <tbody>

                </tbody>
            </table>
        </div>
    </div>
</body>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

<script>

    function enableButtons() {
        changeButtonMode(false)
    }

    function disableButtons() {
        changeButtonMode(true)
    }

    function changeButtonMode(disabled) {
        $("#a0").prop('disabled', disabled);
        $("#a1").prop('disabled', disabled);
        $("#a2").prop('disabled', disabled);
        $("#a3").prop('disabled', disabled);
    }

    function clickAnswer(buttonId) {
        
        disableButtons()

        var contestId = sessionStorage.getItem("contestId")
        var userId = sessionStorage.getItem("userId")
        var questionId = document.getElementById("question").dataset.questionId

        // If used with jquery approach the content is not refreshed correctly when read the dataset
        var aId = document.getElementById(buttonId).dataset.answerId

        $.post({
            url: "/admin/question/answer/" + contestId + "/" + questionId + "/" + aId,
            headers: {
                "userId": userId
            },
            success: function(data, status) {
                $("#" + buttonId).removeClass("btn-light")
                $("#" + buttonId).addClass("btn-success")
            },
            error: function(data, status) {
                $("#" + buttonId).removeClass("btn-light")
                $("#" + buttonId).addClass("btn-danger")
            }
        });
    }

    $(document).ready(function(){
        $.ajax({
            dataType: 'json',
            url: "/admin/register", 
            success: function(data, status) {
                $("#welcome").html("Welcome " + data.user);
                sessionStorage.setItem("userId", data.userId)
                sessionStorage.setItem("contestId", data.contestId)
            }
        });

        $("#a0").click(function() {
            clickAnswer("a0")
        })

        $("#a1").click(function() {
            clickAnswer("a1")
        })

        $("#a2").click(function() {
            clickAnswer("a2")
        })

        $("#a3").click(function() {
            clickAnswer("a3")
        })

    });


    var source = new EventSource("/admin/stream");
    source.onmessage = function (event) {
        // this might change when Quarkus supports the SSE types so we can fill on server side the type of event.
        
        var incomingData = event.data
        var sseContent = JSON.parse(incomingData)

        if (sseContent.type == "end") {
            
            var listOfScores = sseContent.content.scores

            for(var i = 0; i < listOfScores.length; i++) {
                var info = listOfScores[i];
                $("#score").find('tbody')
                    .append($('<tr>')
                        .append($('<th>')
                                .attr("scope", "row")
                                .text(i+1)
                        )
                        .append($('<td>')
                                .text(info.username)
                        )
                        .append($('<td>')
                                .text(info.score)
                        )
                    )
            }

        } else {

            enableButtons()
            var message = sseContent.content
            var question = document.getElementById("question")
            question.innerHTML = message.questionTitle
            question.dataset.questionId=message.questionId

            var answers = message.answers;
            
            var a0 = document.getElementById("a0")
            a0.innerHTML = answers[0].prefix + ') ' + answers[0].answerDescription
            a0.dataset.answerId=answers[0].answerId
            a0.className="btn btn-light"
            
            var a1 = document.getElementById("a1")
            a1.innerHTML = answers[1].prefix + ') ' + answers[1].answerDescription
            a1.dataset.answerId=answers[1].answerId
            a1.className="btn btn-light"

            var a2 = document.getElementById("a2")
            a2.innerHTML = answers[2].prefix + ') ' + answers[2].answerDescription
            a2.dataset.answerId=answers[2].answerId
            a2.className="btn btn-light"

            var a3 = document.getElementById("a3")
            a3.innerHTML = answers[3].prefix + ') ' + answers[3].answerDescription
            a3.dataset.answerId=answers[3].answerId
            a3.className="btn btn-light"
        }

    };
</script>

</html>